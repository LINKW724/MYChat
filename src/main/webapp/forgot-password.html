<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>找回密码</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f2f5; margin: 0; padding: 15px; box-sizing: border-box; }
        .container { padding: 40px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 100%; max-width: 380px; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:disabled { background-color: #a0c7ff; }
        #phase-2 { display: none; } /* 默认隐藏第二阶段 */
        .feedback { color: red; font-size: 12px; height: 15px; text-align: center; margin-top: 10px; font-weight: bold; }
        .login-link { text-align: center; margin-top: 20px; font-size: 14px; }
        .question-display { padding: 10px; background-color: #f7f7f7; border: 1px solid #eee; border-radius: 4px; margin-bottom: 15px; color: #333; min-height: 18px; }
    </style>
</head>
<body>
<div class="container">
    <h2>找回密码</h2>
    <div id="feedback" class="feedback"></div>

    <div id="phase-1">
        <div class="form-group">
            <label for="account">请输入您的账号：</label>
            <input type="text" id="account" name="account" required>
        </div>
        <button id="get-question-btn">获取安全问题</button>
    </div>

    <div id="phase-2">
        <div class="form-group">
            <label>您的安全问题是：</label>
            <div id="question-display" class="question-display"></div>
        </div>
        <div class="form-group">
            <label for="answer">请输入您的答案：</label>
            <input type="text" id="answer" name="answer" required>
        </div>
        <div class="form-group">
            <label for="new-password">请输入新密码：</label>
            <input type="password" id="new-password" name="newPassword" required>
        </div>
        <button id="reset-password-btn">重置密码</button>
    </div>

    <div class="login-link">
        <a href="login.html">返回登录</a>
    </div>
</div>

<script>
    const phase1 = document.getElementById('phase-1');
    const phase2 = document.getElementById('phase-2');
    const getQuestionBtn = document.getElementById('get-question-btn');
    const resetPasswordBtn = document.getElementById('reset-password-btn');
    const accountInput = document.getElementById('account');
    const questionDisplay = document.getElementById('question-display');
    const answerInput = document.getElementById('answer');
    const newPasswordInput = document.getElementById('new-password');
    const feedback = document.getElementById('feedback');

    // 步骤1: 点击按钮，获取安全问题
    getQuestionBtn.addEventListener('click', async () => {
        const account = accountInput.value.trim();
        if (!account) {
            feedback.textContent = '账号不能为空！';
            return;
        }
        feedback.textContent = '';
        getQuestionBtn.disabled = true;
        getQuestionBtn.textContent = '获取中...';

        try {
            // ============ 关键修复：将绝对路径 /api/... 修改为相对路径 api/... ============
            const response = await fetch(`api/forgot-password?account=${encodeURIComponent(account)}`);
            if (response.ok) {
                const data = await response.json();
                if (data.question && data.question.trim() !== '') {
                    questionDisplay.textContent = data.question;
                    phase1.style.display = 'none'; // 隐藏第一阶段
                    phase2.style.display = 'block'; // 显示第二阶段
                } else {
                    feedback.textContent = '账号不存在或未设置安全问题。';
                }
            } else {
                feedback.textContent = `错误: ${response.statusText}`;
            }
        } catch (error) {
            feedback.textContent = '网络请求失败，请稍后再试。';
        } finally {
            getQuestionBtn.disabled = false;
            getQuestionBtn.textContent = '获取安全问题';
        }
    });

    // 步骤2: 点击按钮，提交答案和新密码
    resetPasswordBtn.addEventListener('click', async () => {
        const account = accountInput.value.trim();
        const answer = answerInput.value.trim();
        const newPassword = newPasswordInput.value;

        if (!answer || !newPassword) {
            feedback.textContent = '答案和新密码不能为空！';
            return;
        }
        feedback.textContent = '';
        resetPasswordBtn.disabled = true;
        resetPasswordBtn.textContent = '处理中...';

        const formData = new URLSearchParams();
        formData.append('account', account);
        formData.append('answer', answer);
        formData.append('newPassword', newPassword);

        try {
            // ============ 关键修复：将绝对路径 /api/... 修改为相对路径 api/... ============
            const response = await fetch('api/forgot-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });

            if (response.ok) {
                alert('密码重置成功！将跳转到登录页面。');
                window.location.href = 'login.html?reset=success';
            } else {
                feedback.textContent = '安全问题答案错误！';
            }
        } catch (error) {
            feedback.textContent = '网络请求失败，请稍后再试。';
        } finally {
            resetPasswordBtn.disabled = false;
            resetPasswordBtn.textContent = '重置密码';
        }
    });
</script>
</body>
</html>